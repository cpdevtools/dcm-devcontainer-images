"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Package = void 0;
const dependency_graph_1 = require("dependency-graph");
const fast_glob_1 = __importDefault(require("fast-glob"));
const fs_1 = __importDefault(require("fs"));
const linq_1 = __importDefault(require("linq"));
const posix_1 = __importDefault(require("path/posix"));
const index_js_1 = require("../../utils/index.js");
const PackageManager_1 = require("../PackageManager");
const WorkspaceCallError_1 = require("../WorkspaceCallError");
const WorkspaceCallSuccess_1 = require("../WorkspaceCallSuccess");
class Package {
    constructor(data, path, filename) {
        Object.defineProperty(this, "_path", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "_file", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        Object.defineProperty(this, "_data", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: {}
        });
        Object.defineProperty(this, "_workspaceQuery", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
        this._path = path;
        this._file = filename;
        this._data = data;
    }
    get path() {
        return this._path;
    }
    get fileName() {
        return this._file;
    }
    get fileType() {
        return posix_1.default.extname(this._file);
    }
    get data() {
        return this._data;
    }
    get name() {
        return this.data.name;
    }
    get version() {
        return this.data.version;
    }
    get dependencies() {
        var _a;
        (_a = this.data).dependencies ?? (_a.dependencies = {});
        return this.data.dependencies;
    }
    get devDependencies() {
        var _a;
        (_a = this.data).devDependencies ?? (_a.devDependencies = {});
        return this.data.devDependencies;
    }
    get peerDependencies() {
        var _a;
        (_a = this.data).peerDependencies ?? (_a.peerDependencies = {});
        return this.data.peerDependencies;
    }
    get optionalDependencies() {
        var _a;
        (_a = this.data).optionalDependencies ?? (_a.optionalDependencies = {});
        return this.data.optionalDependencies;
    }
    get dependencyNames() {
        return Object.keys(this.dependencies);
    }
    get devDependencyNames() {
        return Object.keys(this.devDependencies);
    }
    get peerDependencyNames() {
        return Object.keys(this.peerDependencies);
    }
    get optionalDependencyNames() {
        return Object.keys(this.optionalDependencies);
    }
    async execCmd(cmd) {
        const chalk = await (0, index_js_1.importChalk)();
        this.logInfo(chalk.blueBright(`Executing: ${chalk.gray(cmd)}`));
        return await (0, index_js_1.exec)(cmd, { cwd: this.path });
    }
    get scripts() {
        var _a;
        (_a = this.data).scripts ?? (_a.scripts = {});
        return this.data.scripts;
    }
    hasScript(scriptName) {
        return !!this.scripts[scriptName]?.trim();
    }
    async runScript(script, options) {
        const chalk = await (0, index_js_1.importChalk)();
        const opts = {
            ...options,
            throwOnError: options?.throwOnError ?? true,
            throwOnMissing: options?.throwOnMissing ?? true,
        };
        const scriptName = script.split(/\s/, 1)[0].trim();
        if (!this.hasScript(scriptName)) {
            if (opts?.throwOnMissing !== false) {
                this.logError(`Package does't have a script named '${chalk.cyanBright(scriptName)}'`);
                throw new Error(`Package does't have a script named '${scriptName}'`);
            }
            this.logInfo(`Package does't have a script named '${chalk.cyanBright(scriptName)}'. Skipping...`);
            return undefined;
        }
        this.logInfo(chalk.green(`Running ${chalk.cyanBright(scriptName)}`));
        let code = await this.execPackageScript(script);
        if (code !== 0) {
            if (opts?.throwOnError !== false) {
                this.logError(`Script '${chalk.cyanBright(scriptName)}' failed with exit code ${chalk.redBright(code)}`);
                throw new Error(`Script '${scriptName}' failed with exit code ${code}`);
            }
        }
        return code;
    }
    execPackageScript(script) {
        return this.execPackageManager(`run ${script}`);
    }
    get isWorkspace() {
        return !!this.data.workspaces;
    }
    get workspaces() {
        var _a;
        return ((_a = this.data).workspaces ?? (_a.workspaces = []));
    }
    async _workspaceQueryFactory() {
        const base = linq_1.default.from(Array.isArray(this.workspaces)
            ? this.data.workspaces
            : Array.isArray(this.workspaces.packages)
                ? this.workspaces.packages
                : []).select((p) => {
            const result = (0, fast_glob_1.default)(p, { cwd: this.path, onlyDirectories: true });
            return result;
        });
        const packages = linq_1.default.from(await Promise.all(linq_1.default.from(await Promise.all(base.toArray()))
            .selectMany((paths) => paths)
            .select((p) => (posix_1.default.isAbsolute(p) ? p : posix_1.default.join(this.path, p)))
            .where((p) => fs_1.default.existsSync(posix_1.default.join(p, "package.json")))
            .select((p) => PackageManager_1.PackageManager.loadPackage(p)))).orderBy((p) => p.name);
        return packages.asEnumerable();
    }
    get workspaceQuery() {
        return (this._workspaceQuery ?? (this._workspaceQuery = this._workspaceQueryFactory()));
    }
    async listWorkspacePackages() {
        return (await this.workspaceQuery).toArray();
    }
    async listWorkspaceNames() {
        return (await this.workspaceQuery).select((p) => p.name).toArray();
    }
    async listWorkspacePaths() {
        return (await this.workspaceQuery).select((p) => p.path).toArray();
    }
    async workspaceExecute(cmd, options) {
        return this.workspaceCall(async (pkg) => {
            return await pkg.execCmd(cmd);
        }, options);
    }
    workspaceRunScript(cmd, options) {
        return this.workspaceCall(async (pkg) => {
            return await pkg.runScript(cmd, options);
        }, options);
    }
    async workspaceCall(fn, options) {
        const opt = this._applyWorkspaceSortingOptionDefaults(options);
        opt.throwOnError ?? (opt.throwOnError = false);
        const sequence = await this._buildWorkspaceWalkingOrder(opt);
        const results = [];
        for (const parallel of sequence) {
            const parallelPromises = [];
            for (const pkg of parallel) {
                const fnWrapper = async (pkg) => {
                    try {
                        const result = await fn(pkg);
                        return {
                            package: pkg,
                            result: result,
                            success: true,
                        };
                    }
                    catch (e) {
                        if (opt.throwOnError) {
                            throw e;
                        }
                        return {
                            package: pkg,
                            error: e,
                            success: false,
                        };
                    }
                };
                const promise = fnWrapper(pkg);
                parallelPromises.push(promise);
            }
            const result = await Promise.all(parallelPromises);
            results.push(...result);
        }
        const resultsQuery = linq_1.default.from(results);
        const rError = resultsQuery.where((r) => (0, WorkspaceCallError_1.isWorkspaceCallError)(r)).cast();
        const rSuccess = resultsQuery.where((r) => (0, WorkspaceCallSuccess_1.isWorkspaceCallSuccess)(r)).cast();
        return {
            hasErrors: rError.any(),
            errors: rError.toArray(),
            results: rSuccess.toArray(),
        };
    }
    _applyWorkspaceSortingOptionDefaults(options) {
        return {
            ...options,
            parallel: options.parallel ?? false,
            dependencies: options.dependencies ?? false,
            devDependencies: options.devDependencies ?? false,
            optionalDependencies: options.optionalDependencies ?? false,
            peerDependencies: options.peerDependencies ?? false,
        };
    }
    async _buildWorkspaceWalkingOrder(options) {
        let packages = [];
        if (options.dependencies || options.devDependencies || options.peerDependencies || options.optionalDependencies) {
            packages = await this._buildWorkspaceDependencyArray(options);
            if (!options.parallel) {
                packages = packages.flat().map((p) => [p]);
            }
        }
        else {
            const q = await this.workspaceQuery;
            if (options.parallel) {
                packages = [q.toArray()];
            }
            else {
                packages = q.select((p) => [p]).toArray();
            }
        }
        return packages;
    }
    async _buildWorkspaceDependencyArray(opts) {
        const runOrder = [];
        const depGraph = (await this._buildWorkspaceDependencyGraph(opts)).clone();
        let packages = depGraph.overallOrder(true).map((name) => depGraph.getNodeData(name));
        while (packages?.length) {
            runOrder.push(packages);
            packages.forEach((p) => depGraph.removeNode(p.name));
            packages = depGraph.overallOrder(true).map((name) => depGraph.getNodeData(name));
        }
        return runOrder;
    }
    async _buildWorkspaceDependencyGraph(opts) {
        const depGraph = new dependency_graph_1.DepGraph();
        const packagesQuery = await this.workspaceQuery;
        packagesQuery.forEach((pkg) => {
            depGraph.addNode(pkg.name, pkg);
        });
        const deps = packagesQuery.select((p) => ({
            name: p.name,
            deps: [
                ...(!opts.dependencies ? [] : p.dependencyNames),
                ...(!opts.devDependencies ? [] : p.devDependencyNames),
                ...(!opts.peerDependencies ? [] : p.peerDependencyNames),
                ...(!opts.optionalDependencies ? [] : p.optionalDependencyNames),
            ],
        }));
        deps.forEach((p) => {
            p.deps.forEach((d) => {
                depGraph.addDependency(p.name, d);
            });
        });
        return depGraph;
    }
    async printLog(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        return chalk.white(chalk.blueBright(`[${chalk.yellow(this.name)}]`) + ` ${msg}`);
    }
    async logInfo(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        console.info(`${chalk.bgGray.black.bold(" Info ")} ${this.printLog(msg)}`);
    }
    async logWarn(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        console.warn(`${chalk.bgYellow.black.bold(" Warning ")} ${this.printLog(msg)}`);
    }
    async logError(msg) {
        const chalk = await (0, index_js_1.importChalk)();
        console.error(`${chalk.bgRed.white.bold(" ERROR ")} ${this.printLog(msg)}`);
    }
    async install() {
        return await this.execPackageManager("install");
    }
    async workspaceInstall(options) {
        return this.workspaceCall(async (pkg) => {
            return await pkg.install();
        }, options);
    }
}
exports.Package = Package;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFja2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWNrYWdlLW1hbmFnZXJzL2ltcGwvUGFja2FnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx1REFBNEM7QUFDNUMsMERBQTZCO0FBQzdCLDRDQUF3QjtBQUN4QixnREFBOEI7QUFDOUIsdURBQThCO0FBRTlCLG1EQUF5RDtBQUV6RCxzREFBbUQ7QUFFbkQsOERBQWlGO0FBRWpGLGtFQUF1RjtBQUd2RixNQUFzQixPQUFPO0lBSzNCLFlBQW1CLElBQWlCLEVBQUUsSUFBWSxFQUFFLFFBQWdCO1FBSnBFOzs7OztXQUErQjtRQUMvQjs7Ozs7V0FBK0I7UUFDL0I7Ozs7bUJBQTBELEVBQUU7V0FBQztRQXFKN0Q7Ozs7O1dBQTJFO1FBbEp6RSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLElBQWdELENBQUM7SUFDaEUsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sZUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQWMsSUFBSTtRQUNoQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEIsQ0FBQztJQUVELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELElBQVcsT0FBTztRQUNoQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFXLFlBQVk7O1FBQ3JCLE1BQUEsSUFBSSxDQUFDLElBQUksRUFBQyxZQUFZLFFBQVosWUFBWSxHQUFLLEVBQUUsRUFBQztRQUM5QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQ2hDLENBQUM7SUFFRCxJQUFXLGVBQWU7O1FBQ3hCLE1BQUEsSUFBSSxDQUFDLElBQUksRUFBQyxlQUFlLFFBQWYsZUFBZSxHQUFLLEVBQUUsRUFBQztRQUNqQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQ25DLENBQUM7SUFFRCxJQUFXLGdCQUFnQjs7UUFDekIsTUFBQSxJQUFJLENBQUMsSUFBSSxFQUFDLGdCQUFnQixRQUFoQixnQkFBZ0IsR0FBSyxFQUFFLEVBQUM7UUFDbEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO0lBQ3BDLENBQUM7SUFFRCxJQUFXLG9CQUFvQjs7UUFDN0IsTUFBQSxJQUFJLENBQUMsSUFBSSxFQUFDLG9CQUFvQixRQUFwQixvQkFBb0IsR0FBSyxFQUFFLEVBQUM7UUFDdEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDO0lBQ3hDLENBQUM7SUFFRCxJQUFXLGVBQWU7UUFDeEIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsSUFBVyxrQkFBa0I7UUFDM0IsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsSUFBVyxtQkFBbUI7UUFDNUIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRCxJQUFXLHVCQUF1QjtRQUNoQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBVztRQUM5QixNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsc0JBQVcsR0FBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxjQUFjLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDaEUsT0FBTyxNQUFNLElBQUEsZUFBSSxFQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBSUQsSUFBVyxPQUFPOztRQUNoQixNQUFBLElBQUksQ0FBQyxJQUFJLEVBQUMsT0FBTyxRQUFQLE9BQU8sR0FBSyxFQUFFLEVBQUM7UUFDekIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUMzQixDQUFDO0lBRU0sU0FBUyxDQUFDLFVBQWtCO1FBQ2pDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDNUMsQ0FBQztJQUVNLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBYyxFQUFFLE9BQW1DO1FBQ3hFLE1BQU0sS0FBSyxHQUFHLE1BQU0sSUFBQSxzQkFBVyxHQUFFLENBQUM7UUFDbEMsTUFBTSxJQUFJLEdBQXFCO1lBQzdCLEdBQUcsT0FBTztZQUNWLFlBQVksRUFBRSxPQUFPLEVBQUUsWUFBWSxJQUFJLElBQUk7WUFDM0MsY0FBYyxFQUFFLE9BQU8sRUFBRSxjQUFjLElBQUksSUFBSTtTQUNoRCxDQUFDO1FBRUYsTUFBTSxVQUFVLEdBQVcsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDM0QsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDL0IsSUFBSSxJQUFJLEVBQUUsY0FBYyxLQUFLLEtBQUssRUFBRTtnQkFDbEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyx1Q0FBdUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3RGLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLFVBQVUsR0FBRyxDQUFDLENBQUM7YUFDdkU7WUFDRCxJQUFJLENBQUMsT0FBTyxDQUFDLHVDQUF1QyxLQUFLLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ2xHLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFdBQVcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyRSxJQUFJLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNoRCxJQUFJLElBQUksS0FBSyxDQUFDLEVBQUU7WUFDZCxJQUFJLElBQUksRUFBRSxZQUFZLEtBQUssS0FBSyxFQUFFO2dCQUNoQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsMkJBQTJCLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN6RyxNQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsVUFBVSwyQkFBMkIsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUN6RTtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRVMsaUJBQWlCLENBQUMsTUFBYztRQUN4QyxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELElBQVcsV0FBVztRQUNwQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUNoQyxDQUFDO0lBRUQsSUFBVyxVQUFVOztRQUNuQixPQUFPLE9BQUMsSUFBSSxDQUFDLElBQUksRUFBQyxVQUFVLFFBQVYsVUFBVSxHQUFLLEVBQUUsRUFBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFTyxLQUFLLENBQUMsc0JBQXNCO1FBQ2xDLE1BQU0sSUFBSSxHQUFHLGNBQVUsQ0FBQyxJQUFJLENBQzFCLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM1QixDQUFDLENBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUF1QjtZQUNwQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQztnQkFDekMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUTtnQkFDMUIsQ0FBQyxDQUFDLEVBQUUsQ0FDUCxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ2IsTUFBTSxNQUFNLEdBQUcsSUFBQSxtQkFBSSxFQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2xFLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxRQUFRLEdBQUcsY0FBVSxDQUFDLElBQUksQ0FDOUIsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUNmLGNBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2FBQy9DLFVBQVUsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDO2FBQzVCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxlQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2pFLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsWUFBTSxDQUFDLFVBQVUsQ0FBQyxlQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDO2FBQzdELE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsK0JBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDaEQsQ0FDRixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXpCLE9BQU8sUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFHRCxJQUFjLGNBQWM7UUFDMUIsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLEtBQXBCLElBQUksQ0FBQyxlQUFlLEdBQUssSUFBSSxDQUFDLHNCQUFzQixFQUFFLEVBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRU0sS0FBSyxDQUFDLHFCQUFxQjtRQUNoQyxPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDL0MsQ0FBQztJQUVNLEtBQUssQ0FBQyxrQkFBa0I7UUFDN0IsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3JFLENBQUM7SUFFTSxLQUFLLENBQUMsa0JBQWtCO1FBQzdCLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNyRSxDQUFDO0lBRU0sS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQVcsRUFBRSxPQUFnRTtRQUN6RyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ3RDLE9BQU8sTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNkLENBQUM7SUFFTSxrQkFBa0IsQ0FBQyxHQUFXLEVBQUUsT0FBNEQ7UUFDakcsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUN0QyxPQUFPLE1BQU0sR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDM0MsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2QsQ0FBQztJQUVNLEtBQUssQ0FBQyxhQUFhLENBQ3hCLEVBQXdDLEVBQ3hDLE9BQWdFO1FBRWhFLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxvQ0FBb0MsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvRCxHQUFHLENBQUMsWUFBWSxLQUFoQixHQUFHLENBQUMsWUFBWSxHQUFLLEtBQUssRUFBQztRQUUzQixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3RCxNQUFNLE9BQU8sR0FBNkQsRUFBRSxDQUFDO1FBRTdFLEtBQUssTUFBTSxRQUFRLElBQUksUUFBUSxFQUFFO1lBQy9CLE1BQU0sZ0JBQWdCLEdBQW9FLEVBQUUsQ0FBQztZQUM3RixLQUFLLE1BQU0sR0FBRyxJQUFJLFFBQVEsRUFBRTtnQkFDMUIsTUFBTSxTQUFTLEdBQUcsS0FBSyxFQUFFLEdBQW9CLEVBQUUsRUFBRTtvQkFDL0MsSUFBSTt3QkFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFDN0IsT0FBTzs0QkFDTCxPQUFPLEVBQUUsR0FBRzs0QkFDWixNQUFNLEVBQUUsTUFBVzs0QkFDbkIsT0FBTyxFQUFFLElBQUk7eUJBQ2EsQ0FBQztxQkFDOUI7b0JBQUMsT0FBTyxDQUFDLEVBQUU7d0JBQ1YsSUFBSSxHQUFHLENBQUMsWUFBWSxFQUFFOzRCQUNwQixNQUFNLENBQUMsQ0FBQzt5QkFDVDt3QkFDRCxPQUFPOzRCQUNMLE9BQU8sRUFBRSxHQUFHOzRCQUNaLEtBQUssRUFBRSxDQUFDOzRCQUNSLE9BQU8sRUFBRSxLQUFLO3lCQUNlLENBQUM7cUJBQ2pDO2dCQUNILENBQUMsQ0FBQztnQkFDRixNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQy9CLGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUNoQztZQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ25ELE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQztTQUN6QjtRQUNELE1BQU0sWUFBWSxHQUFHLGNBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFOUMsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBQSx5Q0FBb0IsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBOEIsQ0FBQztRQUNyRyxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFBLDZDQUFzQixFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUEyQixDQUFDO1FBRXRHLE9BQU87WUFDTCxTQUFTLEVBQUUsTUFBTSxDQUFDLEdBQUcsRUFBRTtZQUN2QixNQUFNLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUN4QixPQUFPLEVBQUUsUUFBUSxDQUFDLE9BQU8sRUFBRTtTQUM1QixDQUFDO0lBQ0osQ0FBQztJQUVPLG9DQUFvQyxDQUE2QyxPQUFVO1FBQ2pHLE9BQU87WUFDTCxHQUFHLE9BQU87WUFDVixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVEsSUFBSSxLQUFLO1lBQ25DLFlBQVksRUFBRSxPQUFPLENBQUMsWUFBWSxJQUFJLEtBQUs7WUFDM0MsZUFBZSxFQUFFLE9BQU8sQ0FBQyxlQUFlLElBQUksS0FBSztZQUNqRCxvQkFBb0IsRUFBRSxPQUFPLENBQUMsb0JBQW9CLElBQUksS0FBSztZQUMzRCxnQkFBZ0IsRUFBRSxPQUFPLENBQUMsZ0JBQWdCLElBQUksS0FBSztTQUNyQixDQUFDO0lBQ25DLENBQUM7SUFFTyxLQUFLLENBQUMsMkJBQTJCLENBQUMsT0FBZ0M7UUFDeEUsSUFBSSxRQUFRLEdBQXdCLEVBQUUsQ0FBQztRQUN2QyxJQUFJLE9BQU8sQ0FBQyxZQUFZLElBQUksT0FBTyxDQUFDLGVBQWUsSUFBSSxPQUFPLENBQUMsZ0JBQWdCLElBQUksT0FBTyxDQUFDLG9CQUFvQixFQUFFO1lBQy9HLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM5RCxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRTtnQkFDckIsUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUM1QztTQUNGO2FBQU07WUFDTCxNQUFNLENBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDcEMsSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFO2dCQUNwQixRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzthQUMxQjtpQkFBTTtnQkFDTCxRQUFRLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO2FBQzNDO1NBQ0Y7UUFDRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRU8sS0FBSyxDQUFDLDhCQUE4QixDQUFDLElBQTZCO1FBQ3hFLE1BQU0sUUFBUSxHQUF3QixFQUFFLENBQUM7UUFDekMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRTNFLElBQUksUUFBUSxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBb0IsQ0FBQyxDQUFDO1FBRXhHLE9BQU8sUUFBUSxFQUFFLE1BQU0sRUFBRTtZQUN2QixRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3hCLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUssQ0FBQyxDQUFDLENBQUM7WUFDdEQsUUFBUSxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBb0IsQ0FBQyxDQUFDO1NBQ3JHO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVPLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxJQUE2QjtRQUN4RSxNQUFNLFFBQVEsR0FBRyxJQUFJLDJCQUFRLEVBQUUsQ0FBQztRQUNoQyxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksQ0FBQyxjQUFjLENBQUM7UUFDaEQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQzVCLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNuQyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDeEMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJO1lBQ1osSUFBSSxFQUFFO2dCQUNKLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQztnQkFDaEQsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUM7Z0JBQ3RELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUM7Z0JBQ3hELEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUM7YUFDakU7U0FDRixDQUFDLENBQUMsQ0FBQztRQUVKLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNqQixDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUNuQixRQUFRLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDckMsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFUyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQVc7UUFDbEMsTUFBTSxLQUFLLEdBQUcsTUFBTSxJQUFBLHNCQUFXLEdBQUUsQ0FBQztRQUNsQyxPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDbkYsQ0FBQztJQUVTLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBVztRQUNqQyxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsc0JBQVcsR0FBRSxDQUFDO1FBQ2xDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVTLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBVztRQUNqQyxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsc0JBQVcsR0FBRSxDQUFDO1FBQ2xDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEYsQ0FBQztJQUVTLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBVztRQUNsQyxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsc0JBQVcsR0FBRSxDQUFDO1FBQ2xDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUVNLEtBQUssQ0FBQyxPQUFPO1FBQ2xCLE9BQU8sTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVNLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUE0RDtRQUN4RixPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ3RDLE9BQU8sTUFBTSxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDN0IsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ2QsQ0FBQztDQUNGO0FBMVVELDBCQTBVQyJ9